{% extends "base.html" %}

{% block title %}Симуляция - LLM Attack Simulation{% endblock %}

{% block page_header %}
<div class="row mb-4">
    <div class="col-12">
        <h1 class="h2 mb-2">
            <i class="fas fa-play me-2"></i>Симуляция атак
        </h1>
        <p class="text-muted">Запуск и управление симуляциями атак через языковые модели</p>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Основная симуляция -->
<div class="row mb-4">
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-rocket me-2"></i>Запуск симуляции
            </div>
            <div class="card-body">
                <form id="simulationForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="numAttacks" class="form-label">Количество атак</label>
                            <input type="number" class="form-control" id="numAttacks" value="5" min="1" max="100">
                            <div class="form-text">От 1 до 100 атак за один запуск</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="simulationType" class="form-label">Тип симуляции</label>
                            <select class="form-select" id="simulationType">
                                <option value="full">Полная симуляция</option>
                                <option value="attack_only">Только атаки</option>
                                <option value="defense_only">Только защита</option>
                                <option value="network_only">Только сеть</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="targetType" class="form-label">Тип цели</label>
                            <select class="form-select" id="targetType">
                                <option value="random">Случайные цели</option>
                                <option value="users">Только пользователи</option>
                                <option value="servers">Только серверы</option>
                                <option value="critical">Критически важные узлы</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="attackIntensity" class="form-label">Интенсивность атак</label>
                            <select class="form-select" id="attackIntensity">
                                <option value="low">Низкая</option>
                                <option value="medium" selected>Средняя</option>
                                <option value="high">Высокая</option>
                                <option value="extreme">Экстремальная</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="customPrompt" class="form-label">Пользовательский промпт (опционально)</label>
                        <textarea class="form-control" id="customPrompt" rows="3" 
                                  placeholder="Введите собственный промпт для генерации атаки..."></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>Сбросить
                        </button>
                        <button type="submit" class="btn btn-success" id="runSimulationBtn">
                            <i class="fas fa-play me-2"></i>Запустить симуляцию
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Информация о симуляции
            </div>
            <div class="card-body">
                <h6>Типы симуляции:</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-success me-2"></i><strong>Полная:</strong> Все компоненты</li>
                    <li><i class="fas fa-bug text-danger me-2"></i><strong>Атаки:</strong> Только генерация</li>
                    <li><i class="fas fa-shield-alt text-primary me-2"></i><strong>Защита:</strong> Только детекция</li>
                    <li><i class="fas fa-network-wired text-info me-2"></i><strong>Сеть:</strong> Только сеть</li>
                </ul>
                
                <hr>
                
                <h6>Интенсивность:</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-thermometer-empty text-success me-2"></i><strong>Низкая:</strong> 1-5 атак</li>
                    <li><i class="fas fa-thermometer-half text-warning me-2"></i><strong>Средняя:</strong> 5-15 атак</li>
                    <li><i class="fas fa-thermometer-three-quarters text-danger me-2"></i><strong>Высокая:</strong> 15-30 атак</li>
                    <li><i class="fas fa-thermometer-full text-danger me-2"></i><strong>Экстремальная:</strong> 30+ атак</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Результаты симуляции -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-line me-2"></i>Результаты симуляции
                <button class="btn btn-sm btn-outline-secondary float-end" onclick="clearResults()">
                    <i class="fas fa-trash me-1"></i>Очистить
                </button>
            </div>
            <div class="card-body">
                <div id="simulationResults">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-play-circle fa-3x mb-3"></i>
                        <p>Запустите симуляцию для просмотра результатов</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Статистика симуляции -->
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-tachometer-alt me-2"></i>Метрики производительности
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 text-center mb-3">
                        <div class="h4 text-primary" id="avgResponseTime">-</div>
                        <small class="text-muted">Среднее время ответа (мс)</small>
                    </div>
                    <div class="col-6 text-center mb-3">
                        <div class="h4 text-success" id="successRate">-</div>
                        <small class="text-muted">Процент успешности</small>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 text-center mb-3">
                        <div class="h4 text-warning" id="threatDetectionRate">-</div>
                        <small class="text-muted">Обнаружение угроз</small>
                    </div>
                    <div class="col-6 text-center mb-3">
                        <div class="h4 text-info" id="networkIntegrity">-</div>
                        <small class="text-muted">Целостность сети</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-history me-2"></i>История симуляций
            </div>
            <div class="card-body">
                <div id="simulationHistory">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-history fa-2x mb-2"></i>
                        <p>История симуляций пуста</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Дополнительные опции -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cog me-2"></i>Дополнительные опции
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableLogging" checked>
                            <label class="form-check-label" for="enableLogging">
                                Подробное логирование
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableNotifications" checked>
                            <label class="form-check-label" for="enableNotifications">
                                Уведомления в реальном времени
                            </label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoSaveResults">
                            <label class="form-check-label" for="autoSaveResults">
                                Автосохранение результатов
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="exportFormat" class="form-label">Формат экспорта</label>
                        <select class="form-select" id="exportFormat">
                            <option value="json">JSON</option>
                            <option value="csv">CSV</option>
                            <option value="html">HTML</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="simulationTimeout" class="form-label">Таймаут симуляции (сек)</label>
                        <input type="number" class="form-control" id="simulationTimeout" value="300" min="60" max="3600">
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-outline-primary me-md-2" onclick="exportResults()">
                        <i class="fas fa-download me-2"></i>Экспорт результатов
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="saveConfiguration()">
                        <i class="fas fa-save me-2"></i>Сохранить конфигурацию
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let simulationHistory = [];
let currentResults = null;

// Обработка формы симуляции
document.getElementById('simulationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    runSimulation();
});

function runSimulation() {
    const formData = {
        num_attacks: parseInt(document.getElementById('numAttacks').value),
        simulation_type: document.getElementById('simulationType').value,
        target_type: document.getElementById('targetType').value,
        attack_intensity: document.getElementById('attackIntensity').value,
        custom_prompt: document.getElementById('customPrompt').value,
        enable_logging: document.getElementById('enableLogging').checked,
        enable_notifications: document.getElementById('enableNotifications').checked,
        auto_save: document.getElementById('autoSaveResults').checked,
        timeout: parseInt(document.getElementById('simulationTimeout').value)
    };
    
    // Показываем загрузку
    const btn = document.getElementById('runSimulationBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Запуск...';
    btn.disabled = true;
    
    // Запускаем симуляцию
    fetch('/api/run_simulation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentResults = data.results;
            displayResults(data.results);
            addToHistory(data.results, formData);
            updateMetrics(data.results);
            
            if (formData.enable_notifications) {
                showNotification('Симуляция завершена успешно!', 'success');
            }
            
            if (formData.auto_save) {
                saveResults(data.results);
            }
        } else {
            showNotification('Ошибка при запуске симуляции: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Ошибка при запуске симуляции: ' + error, 'error');
    })
    .finally(() => {
        // Восстанавливаем кнопку
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function displayResults(results) {
    const resultsDiv = document.getElementById('simulationResults');
    
    let html = `
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <div class="h3 text-success">${results.total_attacks || 0}</div>
                        <small class="text-muted">Всего атак</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <div class="h3 text-danger">${results.successful_attacks || 0}</div>
                        <small class="text-muted">Успешных атак</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <div class="h3 text-primary">${results.threats_detected || 0}</div>
                        <small class="text-muted">Угроз обнаружено</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <div class="h3 text-info">${results.network_integrity ? (results.network_integrity * 100).toFixed(1) + '%' : 'N/A'}</div>
                        <small class="text-muted">Целостность сети</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <h6>Детали симуляции:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <td><strong>Время выполнения:</strong></td>
                                <td>${results.execution_time || 'N/A'} сек</td>
                            </tr>
                            <tr>
                                <td><strong>Память использована:</strong></td>
                                <td>${results.memory_used || 'N/A'} МБ</td>
                            </tr>
                            <tr>
                                <td><strong>Статус:</strong></td>
                                <td><span class="badge bg-success">Завершено</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = html;
}

function addToHistory(results, config) {
    const historyItem = {
        timestamp: new Date().toLocaleString(),
        config: config,
        results: results
    };
    
    simulationHistory.unshift(historyItem);
    
    // Ограничиваем историю 10 последними симуляциями
    if (simulationHistory.length > 10) {
        simulationHistory = simulationHistory.slice(0, 10);
    }
    
    updateHistoryDisplay();
}

function updateHistoryDisplay() {
    const historyDiv = document.getElementById('simulationHistory');
    
    if (simulationHistory.length === 0) {
        historyDiv.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-history fa-2x mb-2"></i>
                <p>История симуляций пуста</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    
    simulationHistory.forEach((item, index) => {
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <div class="fw-bold">Симуляция ${index + 1}</div>
                    <small class="text-muted">${item.timestamp}</small>
                    <br>
                    <small class="text-muted">
                        ${item.config.num_attacks} атак, 
                        ${item.config.simulation_type}, 
                        ${item.config.attack_intensity}
                    </small>
                </div>
                <div class="text-end">
                    <div class="badge bg-success">${item.results.successful_attacks || 0}</div>
                    <br>
                    <small class="text-muted">успешных</small>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    historyDiv.innerHTML = html;
}

function updateMetrics(results) {
    // Обновляем метрики производительности
    document.getElementById('avgResponseTime').textContent = 
        results.avg_response_time ? results.avg_response_time.toFixed(2) : 'N/A';
    
    const successRate = results.total_attacks ? 
        ((results.successful_attacks || 0) / results.total_attacks * 100).toFixed(1) : 'N/A';
    document.getElementById('successRate').textContent = 
        successRate === 'N/A' ? 'N/A' : successRate + '%';
    
    const detectionRate = results.total_attacks ? 
        ((results.threats_detected || 0) / results.total_attacks * 100).toFixed(1) : 'N/A';
    document.getElementById('threatDetectionRate').textContent = 
        detectionRate === 'N/A' ? 'N/A' : detectionRate + '%';
    
    const integrity = results.network_integrity ? 
        (results.network_integrity * 100).toFixed(1) : 'N/A';
    document.getElementById('networkIntegrity').textContent = 
        integrity === 'N/A' ? 'N/A' : integrity + '%';
}

function resetForm() {
    document.getElementById('simulationForm').reset();
    document.getElementById('numAttacks').value = '5';
    document.getElementById('simulationType').value = 'full';
    document.getElementById('targetType').value = 'random';
    document.getElementById('attackIntensity').value = 'medium';
    document.getElementById('customPrompt').value = '';
    document.getElementById('simulationTimeout').value = '300';
}

function clearResults() {
    document.getElementById('simulationResults').innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="fas fa-play-circle fa-3x mb-3"></i>
            <p>Запустите симуляцию для просмотра результатов</p>
        </div>
    `;
    currentResults = null;
}

function exportResults() {
    if (!currentResults) {
        showNotification('Нет результатов для экспорта', 'warning');
        return;
    }
    
    const format = document.getElementById('exportFormat').value;
    const dataStr = JSON.stringify(currentResults, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `simulation_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.${format}`;
    link.click();
    
    showNotification('Результаты экспортированы', 'success');
}

function saveConfiguration() {
    const config = {
        num_attacks: document.getElementById('numAttacks').value,
        simulation_type: document.getElementById('simulationType').value,
        target_type: document.getElementById('targetType').value,
        attack_intensity: document.getElementById('attackIntensity').value,
        simulation_timeout: document.getElementById('simulationTimeout').value,
        enable_logging: document.getElementById('enableLogging').checked,
        enable_notifications: document.getElementById('enableNotifications').checked,
        auto_save: document.getElementById('autoSaveResults').checked,
        export_format: document.getElementById('exportFormat').value
    };
    
    localStorage.setItem('simulationConfig', JSON.stringify(config));
    showNotification('Конфигурация сохранена', 'success');
}

function loadConfiguration() {
    const saved = localStorage.getItem('simulationConfig');
    if (saved) {
        const config = JSON.parse(saved);
        document.getElementById('numAttacks').value = config.num_attacks || 5;
        document.getElementById('simulationType').value = config.simulation_type || 'full';
        document.getElementById('targetType').value = config.target_type || 'random';
        document.getElementById('attackIntensity').value = config.attack_intensity || 'medium';
        document.getElementById('simulationTimeout').value = config.simulation_timeout || 300;
        document.getElementById('enableLogging').checked = config.enable_logging !== false;
        document.getElementById('enableNotifications').checked = config.enable_notifications !== false;
        document.getElementById('autoSaveResults').checked = config.auto_save || false;
        document.getElementById('exportFormat').value = config.export_format || 'json';
    }
}

function saveResults(results) {
    const savedResults = JSON.parse(localStorage.getItem('savedResults') || '[]');
    savedResults.push({
        timestamp: new Date().toISOString(),
        results: results
    });
    
    // Ограничиваем количество сохраненных результатов
    if (savedResults.length > 50) {
        savedResults.splice(0, savedResults.length - 50);
    }
    
    localStorage.setItem('savedResults', JSON.stringify(savedResults));
}

// Загружаем сохраненную конфигурацию при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadConfiguration();
});
</script>
{% endblock %}
